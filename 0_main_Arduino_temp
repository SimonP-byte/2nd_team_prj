
#include <SoftwareSerial.h>

#define Tx_pin 8
#define Rx_pin 7
#define RS485_EN 2

SoftwareSerial RS485(Rx_pin, Tx_pin);

char rx_buf[20];
char tx_buf[20] = "S00101\n";
unsigned char rxd;
char rx_flag = 0;
int i = 0;
char led_flag = 0;

void serialEvent(){
  rxd = Serial.read();
  rx_flag = 1;
}

void setup() {
  // 송-수신, 485 Enable 핀 초기화 
  pinMode(Rx_pin, INPUT);
  pinMode(Tx_pin, OUTPUT);
  pinMode(RS485_EN, OUTPUT);
  digitalWrite(RS485_EN, 0); // 485 기본상태 = 수신

  // 소프트웨어, 하드웨어 Serial 통신 시작
  RS485.begin(9600);  // Software UART
  Serial.begin(115200); // Hardware UART

  pinMode(13, OUTPUT);
}

void loop() {
  
  // 수신 - 프로토콜 종료 == '\n'
  while(RS485.available()){
    rx_buf[i] = RS485.read();
    if(rx_buf[i] == '\n') {
      i = 0;
      Serial.print(rx_buf);
      break;
    }
    i++;
  }
  delay(500);
  
  // 송신 - rx_buf[1 ~ 3] == 아두이노 일련번호 (해당 기기의 경우 001)
  //        rx_buf[4 ~ 5] == 수행동작 명령
  //        if(rx_buf[4, 5] == 00) -> 센서값을 Rpi측으로 전송
  //        if(rx_buf[4, 5] == 01) -> ex)모터 작동
  if(rx_buf[1] == '0' && rx_buf[2] == '0' && rx_buf[3] == '1'){
    if(rx_buf[4] == '0' && rx_buf[5] == '0'){
      digitalWrite(RS485_EN, 1);
      RS485.write(tx_buf);
      for(int k=0; k < 20; k++) rx_buf[k] = 0;
      digitalWrite(RS485_EN, 0);
    }
    else if(rx_buf[4] == '0' && rx_buf[5] == '1'){
      led_flag = 1;      
    }
    delay(500);
  }
  
  if(led_flag == 1){
    while(1){
      digitalWrite(13, 0);
      delay(200);
      digitalWrite(13, 1);
      delay(200);
    }
  }
}
